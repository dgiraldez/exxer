<!--[if IE 7]>
<!DOCTYPE>
<html lang="en">
	<head>
<![endif]-->
<!--[if IE 8]>
<!DOCTYPE>
<html lang="en">
    <head>
           <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
<![endif]-->

<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
<title>Exxer monitor</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<link rel="stylesheet" href="dojo-release-1.9.1/dojox/grid/resources/claroGrid.css" media="screen">
<link rel="stylesheet" href="dojo-release-1.9.1/dijit/themes/claro/claro.css" media="screen">
<link rel="stylesheet" href="resources/demo.css" media="screen">
<!-- 
<link rel="stylesheet" href="resources/Legend.css" media="screen">
 -->
<!-- 
		<style>
			.dojoxLegendNode {border: 1px solid #ccc; margin: 5px 10px 5px 10px; padding: 3px}
			.dojoxLegendText {vertical-align: text-top; padding-right: 10px}
		</style>
 -->
	
<script>
	dojoConfig = { async : true, parseOnLoad : true }
</script>
<script src="dojo-release-1.9.1/dojo/dojo.js"></script>
<script>

require(["dojo/store/JsonRest", "dojo/store/Memory", "dojo/store/Cache", "dojo/store/Observable"], function(JsonRest, Memory, Cache, Observable){
	samples = new Observable(new Cache(
		JsonRest({
			target:"/projects/monitor/api/samples/",
			idProperty: "id"
		}), 
		new Memory()
	));
});

require(["dojo/store/JsonRest", "dojo/store/Memory", "dojo/store/Cache"], function(JsonRest, Memory, Cache){
	inputs = new Cache(JsonRest({target:"/projects/monitor/api/input/",idProperty: "id"}), new Memory());
});
				

function formatDay(o) { //retorna el string con el rango de fechas para el query
	var dt = new Date();
	if (o != null){
		dt.setTime(o);
	}
	return dojo.date.locale.format(dt, {datePattern: "yyyy-MM-dd", selector: "date"});
}

function nextDay(o){
	return dojo.date.add(o,"day",1);
}

function prevDay(o){
	return dojo.date.add(o,"day",-1);
}

function getFilter(v){
	return "created < '"+formatDay(nextDay(v))+"' and created > '"+formatDay(v)+"'";
}

//retorna la cantidad de minutos desde las cero hs: se usa para el eje x
function created2minute(dateStr) {
	var a = dateStr.split(" ");
	var t = a[1].split(":");
	var minute = (+t[0]) * 60 + (+t[1]);
	return minute;
}

//retorna un string MM/dd/YYYY
function labelfTime(o) {
	var dt = new Date();
	dt.setTime(o);
	return dojo.date.locale.format(dt, {datePattern: "MM/dd/yyyy", selector: "date"});
}

//retorna un string HH:MM, a partir de la cantidad de minutos
function labelHHMM(o) {
	return dojo.date.locale.format(
		new Date(0,0,0,o/60,o%60,0), 
		{timePattern: "HH:mm", selector: "time"}
	)+" hs";
}

//retorna un date
function dateTimeStr2Date(dateStr) {
	var a = dateStr.split(" ");
	var d = a[0].split("-");
	var t = a[1].split(":");
	var myDate = new Date(d[0], (d[1] - 1), d[2], t[0], t[1], t[2]);
	return myDate;
//	return dojo.date.locale.parse(dateStr, {datePattern: "yyyy-MM-dd HH:mm:ss"});
}

function getDot(item, store){
	var o = {
		x: created2minute(item["created"]),
		y: item["value"]
		//tooltip: item["id"]
		//color: "red"
	};
	return o;
}

params = [];
params[1] = {min:-93, max:-57, title:"Temperaturas Freezer"};
params[2] = {min:-5, max:40, title:"Temperaturas ambiente"};
params[3] = {min:195, max:245, title:"Tensiones de linea"};
groups = 1;

require(["dojo/date", 'dijit/form/DateTextBox', 'dojo/domReady!', "dojox/charting/StoreSeries", "dojo/_base/array"], function (date, DateTextBox, ready, StoreSeries, array) {
    //initial value current date
    myDate = new DateTextBox({
        //value: new Date(2013,9,25),
        value: new Date(),
        name: "myDate",
        onChange: function(v){
			inputs.query({groups:groups}).then(function(inputs) {
				dojo.forEach(inputs, function(input, i){
					samples.query({ input_id:input.id, filter:getFilter(myDate.value) }).then(function(result) {
						chart.updateSeries(input.description, array.map(result, getDot, this), true).delayedRender();
					});
				});
			});
			legend.refresh();
        }
	}, "myDate");
});

require(["dojox/charting/Chart", "dojox/charting/themes/Claro", "dojox/charting/axis2d/Default", "dojox/charting/plot2d/Lines", "dojo/ready", "dojox/charting/StoreSeries", 
         "dojox/charting/plot2d/MarkersOnly", "dojox/charting/plot2d/Indicator", "dojox/charting/action2d/MouseZoomAndPan",
         "dojox/charting/widget/Legend", "dojox/charting/action2d/Tooltip"],
		  function(Chart, Claro, Default, LinesPlot, ready, StoreSeries, MarkersOnly, Indicator, MouseZoomAndPan, Legend, Tooltip){
		  ready(function(){
			
		    chart = new Chart("chart");
		    chart.addPlot("lines", {type: LinesPlot, markers: true});
		    chart.addAxis("x", {
		    	labelFunc:labelHHMM,
		    	font: "normal normal normal 10pt Tahoma",
				min : 0,
				max : 1440
		    });
		    chart.addAxis("y", {
		    	vertical: true,
		    	font: "normal normal normal 10pt Tahoma",
				min : params[groups].min,
				max : params[groups].max
		    });
				//console.log(inputValues["1"]);
				inputs.query({groups:groups}).then(function(inputs) {
					dojo.forEach(inputs, function(input, i){
						//console.log(input.id);
					    chart.addSeries(input.description, 
					    		StoreSeries( samples, {query: { input_id:input.id, filter:getFilter(myDate.value) }}, getDot ), 
					    		{stroke: {color: input.color}, plot:"lines"});
						chart.addPlot("thresholdm"+input.id, {
							type: Indicator,
							vertical: false, lineStroke: { color: input.color, style: "ShortDash"},
							stroke: null, outline: null, fill: null,
							offset: { y: 4, x: 10 },
							values: +input.min
							});
						chart.addPlot("thresholdM"+input.id, {
							type: Indicator,
							vertical: false, lineStroke: { color: input.color, style: "ShortDash"},
							stroke: null, outline: null, fill: null,
							offset: { y: 4, x: 10 },
							values: +input.max
							});
					});
				});
				var tip = new Tooltip(chart,"lines");
				var mag2 = new MouseZoomAndPan(chart, "lines");
			    chart.render();
			    legend = new Legend({chartRef:chart}, "legend");
			    setTimeout(function(){ legend.refresh() }, 1000);
		  });
		});
</script>
  </head>
<body class="claro" style="height: 90%; width: 90%">
	<h1>Temperaturas Freezer</h1>
	<input id="myDate" type="text" name="myDate" data-dojo-type="dijit.form.DateTextBox" required="true"/>
	<p></p>
	<div id="chart" style="width: 100%; height: 90%;"></div>
	<div id="legend"></div>
	
	<p></p>
	<a href="displaySamples.html">[Inicio]</a>
	<a href="graph2.html">[Temperaturas ambiente]</a>		
	<a href="graph3.html">[Tensiones de linea]</a>		
  </body>
</html>